name: Docker Hub CI/CD Pipeline

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'

jobs:
  integration:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Lint and Test
        run: |
          echo "Running Linting"
          echo "Running Unit Tests"

  build-and-push:
    name: Build & Push to Docker Hub
    needs: integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # This automatically uses your GitHub Project Name as the Docker Repo Name
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest

  deployment:
    name: Deployment to Self-Hosted Server
    needs: build-and-push
    runs-on: self-hosted
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull and Restart Container
        run: |
          # Define the dynamic image name locally
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest"
          
          # Pull the latest image from Docker Hub
          docker pull $IMAGE_NAME
          
          # Stop and remove the old container if it exists
          docker ps -q --filter "name=my-app-container" | grep -q . && docker stop my-app-container && docker rm -fv my-app-container || true
          
          # Start the new container
          docker run -d -p 8080:8080 --name=my-app-container $IMAGE_NAME
          
          # Clean up old unused images to save disk space
          docker image prune -f