name: Local Machine Multi-Server Deploy

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest

  deploy-test:
    needs: build
    runs-on: [self-hosted, testing-server]
    steps:
      - name: Login to Docker Hub locally
        shell: powershell
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Deploy to Test (Port 9090)
        shell: powershell
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest
          if (docker ps -aq --filter "name=test-app") { docker stop test-app; docker rm test-app }
          docker run -d --name test-app -p 9090:8080 ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest

  deploy-prod:
    needs: deploy-test
    environment: production
    runs-on: [self-hosted, prod-server]
    steps:
      - name: Login to Docker Hub locally
        shell: powershell
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Deploy to Prod (Port 8080)
        shell: powershell
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest
          if (docker ps -aq --filter "name=prod-app") { docker stop prod-app; docker rm prod-app }
          docker run -d --name prod-app -p 8080:8080 ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}:latest